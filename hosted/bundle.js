(()=>{var e={867:(e,n,t)=>{const{drawingBoardWidth:a,drawingBoardHeight:r}=t(661);let o,i,s,c=!1;const d=e=>{const n={};let t,o;return"touchmove"===e.type?(t=e.touches[0].pageX,o=e.touches[0].pageY):"mousemove"===e.type&&(t=e.pageX,o=e.pageY),n.x=(t-i.offsetLeft)*(a/i.offsetWidth),n.y=(o-i.offsetTop)*(r/i.offsetHeight),n},l=e=>{c=!0;const{x:n,y:t}=d(e);s.beginPath(),s.moveTo(n,t),s.lineTo(n,t),s.stroke()},m=e=>{if(!c)return;const{x:n,y:t}=d(e);s.lineTo(n,t),s.stroke()},g=()=>{c=!1,s.closePath()};e.exports={init:()=>(o=document.querySelector("#drawingBoard"),i=document.querySelector("#drawingBoardOuter"),!!(o.getContext&&o.getContext("2d")&&o.toDataURL&&o.toDataURL())&&(s=o.getContext("2d"),i.onmousedown=l,i.onmousemove=m,i.onmouseup=g,i.onmouseout=g,i.ontouchstart=l,i.ontouchend=g,i.ontouchmove=m,i.ontouchcancel=g,s.lineWidth=3,s.strokeStyle="black",s.lineCap="round",s.lineJoin="round",!0)),toDataURL:()=>o.toDataURL(),getImageArray:()=>s.getImageData(0,0,a,r).data,drawImageData:e=>s.putImageData(e,0,0),drawImage:async e=>{const n=await(e=>new Promise(((n,t)=>{const a=new Image;a.crossOrigin="Anonymous",a.src=e,a.onload=()=>{n(a)},a.onerror=e=>{t(e)}})))(e);s.drawImage(n,0,0)},clear:()=>{const e=s.fillStyle;s.fillStyle="white",s.fillRect(0,0,a,r),s.fillStyle=e}}},661:e=>{e.exports={drawingBoardWidth:640,drawingBoardHeight:480}},17:e=>{e.exports={clientHeaders:{newGame:0,joinGame:1,submitScribble:4,submitExpension:5,updateReady:6},serverHeaders:{errorMsg:0,newGameCreated:1,gameStarting:2,scribbleDone:3,expensionDone:4}}},454:e=>{const n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";e.exports={makeNewCode:e=>{let t;do{t="";for(let e=0;e<3;e++)t+=n[Math.floor(26*Math.random())]}while(e&&e[t]);return t},validateCode:(e,t,a)=>{if(!e)return"No game code specified.";const r=e.length;for(let t=0;t<r;t++){const a=e[t];if(!n.includes(a))return"Invalid game code character(s)."}if(3!==r)return"Invalid game code length.";if(t){if(!t[e])return`No game with code ${e} has been created.`;if(a&&0!==t[e].state)return`The game with code ${e} is already in progress.`}return null}}}},n={};function t(a){var r=n[a];if(void 0!==r)return r.exports;var o=n[a]={exports:{}};return e[a](o,o.exports,t),o.exports}(()=>{const e=t(454),n=t(867),{clientHeaders:a,serverHeaders:r}=t(17),{drawingBoardWidth:o,drawingBoardHeight:i}=t(661),s=`ws://${window.location.hostname}:443`;let c,d,l={},m={};const g=e=>{const n=new Uint8Array(e),t=n[0],a=n.slice(1),s={header:t};switch(t){case r.errorMsg:case r.newGameCreated:s.string=String.fromCharCode(...a);break;case r.gameStarting:[s.round,s.whoScribbles]=a;break;case r.scribbleDone:case r.expensionDone:s.imageData=new ImageData(new Uint8ClampedArray(a),o,i)}return s},u=(e,n)=>{const t=n||(e=>e),a={};for(let n=0;n<e.length;n++){const r=e[n];a[r]=document.querySelector(`#${t(r)}`)}return a},w=e=>{l[e]&&Object.keys(l).forEach((n=>{l[n].classList.toggle("activeScreen",n===e)}))},b=(e,t,o,i,s)=>{const l=()=>{m.finalScribble.src=c,m.finalExpension.src=d,m.saveDrawingsButton.onclick=()=>{(e=>{const n=t=>{if(t>=e.length)return;const a=e[t],r=document.createElement("a");r.href=a.url,r.target="_parent","download"in r&&(r.download=a.filename),(document.body||document.documentElement).appendChild(r),r.click(),r.remove(),setTimeout((()=>n(t+1)),500)};n(0)})([{url:c,filename:`expensiongame_${e}_round${o+1}_1`},{url:d,filename:`expensiongame_${e}_round${o+1}_2`}])},w("done");const n=a=>{const o=g(a.data);o.header===r.gameStarting&&(t.removeEventListener("message",n),b(e,t,o.round,o.whoScribbles,s))};t.addEventListener("message",n)};if(m.finalScribble.classList.remove("finalDrawingActive"),m.finalExpension.classList.add("finalDrawingActive"),m.finalScribbleOrExpension.checked=!0,m.playAgainCheckbox.checked=!1,c=void 0,d=void 0,m.whyAmIWaiting.innerHTML="Waiting for the other player to make a scribble...",m.whatAmIDrawing.innerHTML="Make a scribble!",n.clear(),m.playAgainCheckbox.onclick=e=>{t.send(new Uint8Array([a.updateReady,e.target.checked?1:0]).buffer)},i===s)w("drawing"),m.submitDrawingButton.onclick=()=>{c=n.toDataURL(),t.send(new Uint8Array([a.submitScribble,...n.getImageArray()]).buffer),m.whyAmIWaiting.innerHTML="Waiting for the other player to make an exPENsion of your scribble...",w("waiting");const e=a=>{const o=g(a.data);o.header===r.expensionDone&&(t.removeEventListener("message",e),n.drawImageData(o.imageData),d=n.toDataURL(),l())};t.addEventListener("message",e)};else{w("waiting");const e=o=>{const i=g(o.data);i.header===r.scribbleDone&&(t.removeEventListener("message",e),n.drawImageData(i.imageData),c=n.toDataURL(),m.submitDrawingButton.onclick=()=>{d=n.toDataURL(),t.send(new Uint8Array([a.submitExpension,...n.getImageArray()]).buffer),l()},m.whatAmIDrawing.innerHTML="It's exPENsion time! Turn this scribble into a coherent drawing!",w("drawing"))};t.addEventListener("message",e)}};window.onload=()=>{l=u(["start","displayCode","inputCode","waiting","drawing","done","noCanvas"],(e=>`${e}Screen`)),m=u(["newGameButton","newGameError","joinGameButton","codeDisplay","codeInput","submitJoinCodeButton","joinError","whyAmIWaiting","whatAmIDrawing","submitDrawingButton","finalScribble","finalExpension","finalScribbleOrExpension","saveDrawingsButton","playAgainCheckbox"]),n.init()||w("noCanvas");const t=e=>{m.newGameButton.disabled=e,m.joinGameButton.disabled=e,m.submitJoinCodeButton.disabled=e,m.codeInput.disabled=e},o=()=>{t(!1),w("start"),m.newGameError.innerHTML="Connection lost."};m.newGameButton.onclick=()=>{m.newGameError.innerHTML="",t(!0);const e=new WebSocket(s);e.binaryType="arraybuffer",e.addEventListener("open",(()=>{e.send(new Uint8Array([a.newGame]).buffer)})),e.addEventListener("close",o);const n=a=>{const i=g(a.data),{header:s}=i;if(e.removeEventListener("message",n),s===r.errorMsg)t(!1),m.newGameError.innerHTML=i.string,e.removeEventListener("close",o),e.close();else if(s===r.newGameCreated){const n=i.string;m.codeDisplay.innerHTML=n,w("displayCode");const t=a=>{const r=g(a.data);e.removeEventListener("message",t),b(n,e,r.round,r.whoScribbles,0)};e.addEventListener("message",t)}};e.addEventListener("message",n)},m.joinGameButton.onclick=()=>w("inputCode");const i=async()=>{m.joinError.innerHTML="",t(!0);const n=m.codeInput.value.toUpperCase(),i=e.validateCode(n);if(i)t(!1),m.joinError.innerHTML=i.message;else{const e=new WebSocket(s);e.binaryType="arraybuffer",e.addEventListener("open",(()=>{e.send(((e,[...n])=>new Uint8Array([e,...n.map((e=>e.charCodeAt(0)))]).buffer)(a.joinGame,n))})),e.addEventListener("close",o);const i=a=>{const s=g(a.data),{header:c}=s;e.removeEventListener("message",i),c===r.errorMsg?(t(!1),m.joinError.innerHTML=s.string,console.log(s),e.removeEventListener("close",o),e.close()):c===r.gameStarting&&(m.codeInput.value="",b(n,e,s.round,s.whoScribbles,1))};e.addEventListener("message",i)}};m.submitJoinCodeButton.onclick=i,m.codeInput.onkeypress=e=>{"Enter"===(e.code||e.key)&&i()},m.finalScribbleOrExpension.onclick=e=>{const n=e.target.checked;m.finalScribble.classList[n?"remove":"add"]("finalDrawingActive"),m.finalExpension.classList[n?"add":"remove"]("finalDrawingActive")}}})()})();